const http=require('http'); const fs=require('fs'); const path=require('path'); const {Pool}=require('pg');
const pool=new Pool({host:process.env.DB_HOST||'127.0.0.1',user:process.env.DB_USER||'wedding',password:process.env.DB_PASS||'',database:process.env.DB_NAME||'wedding',port:5432});

// –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è
const WEDDING_TS = Date.parse('2026-07-04T15:00:00+03:00');

// rate-limit
const RATE=new Map(); function okRate(ip){const now=Date.now(),w=5*60*1000; if(!RATE.has(ip)) RATE.set(ip,[]); const a=RATE.get(ip).filter(t=>now-t<w); a.push(now); RATE.set(ip,a); return a.length<=3;}

const page = `<!doctype html><meta charset="utf-8"><title>–°–≤–∞–¥—å–±–∞ –ö–∞—Ä–º–∞–Ω–æ–≤—ã—Ö</title>
<style>
body{font-family:system-ui;background:#F6F4F2;color:#2B2B2B;margin:0}
.w{max-width:960px;margin:0 auto;padding:24px}
.nav{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.pill{display:inline-block;background:#E8EFE4;border:1px solid #0001;border-radius:999px;padding:6px 12px;font-weight:700;text-decoration:none;color:inherit}
.grid{display:grid;gap:16px;grid-template-columns:1.3fr 1fr}@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid #0001;border-radius:16px;padding:16px}
input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #0003}
.btn{background:#C9D7C2;border:0;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
.badge{display:inline-block;background:#F7DDE2;padding:6px 10px;border-radius:999px;font-weight:700}
.count{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center}
.cell{background:#fff;border:1px solid #0001;border-radius:12px;padding:10px}
.hi{display:none;background:#E7F6EA;border:1px solid #BFE3C4;border-radius:12px;padding:10px 12px;margin:12px 0;font-weight:700}
.hero{border-radius:16px;overflow:hidden;border:1px solid #0001}
.ok{color:#317031;font-weight:700;margin-top:8px}
.kit{display:grid;gap:16px;grid-template-columns:1fr 1fr}@media(max-width:900px){.kit{grid-template-columns:1fr}}
.kbtn{display:inline-block;background:#c9d7c2;border:1px solid #0002;border-radius:10px;padding:10px 14px;text-decoration:none;color:inherit;font-weight:700}
.note{opacity:.75}
</style>
<div class="w">
  <div class="nav">
    <span class="pill">–°–≤–∞–¥—å–±–∞ –ö–∞—Ä–º–∞–Ω–æ–≤—ã—Ö</span>
    <a class="pill" href="/lk">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
  </div>

  <div class="grid">
    <div>
      <h1>–ê–ª–µ–∫—Å–∞–Ω–¥—Ä & –ï–ª–µ–Ω–∞ ‚Äî –ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –í–æ–¥—ã</h1>
      <p><span class="badge">4‚Äì5 –∏—é–ª—è 2026</span> ‚Ä¢ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ–∑–∂–µ</p>
      <div id="hi" class="hi">–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.</div>
      <div class="count">
        <div class="cell"><div id="cd">‚Äî</div><div>–¥–Ω–µ–π</div></div>
        <div class="cell"><div id="ch">‚Äî</div><div>—á–∞—Å–æ–≤</div></div>
        <div class="cell"><div id="cm">‚Äî</div><div>–º–∏–Ω—É—Ç</div></div>
        <div class="cell"><div id="cs">‚Äî</div><div>—Å–µ–∫—É–Ω–¥</div></div>
      </div>
    </div>
    <div>
      <img class="hero" src="/hero.jpg" alt="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –∏ –ï–ª–µ–Ω–∞" onerror="this.style.display='none'">
    </div>
  </div>

  <!-- NEW: –ú—ã –∂–µ–Ω–∏–º—Å—è -->
  <div class="card" style="margin-top:16px">
    <h3>–ú—ã –∂–µ–Ω–∏–º—Å—è!</h3>
    <div class="kit">
      <div>
        <p>–î—Ä—É–∑—å—è –∏ –±–ª–∏–∑–∫–∏–µ, –º—ã —Ä–∞–¥—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–≤–æ—Å—Ç—å—é ‚Äî —Å–∫–æ—Ä–æ –Ω–∞—à–∞ —Å–≤–∞–¥—å–±–∞. –û—á–µ–Ω—å –∂–¥—ë–º –≤—Å—Ç—Ä–µ—á–∏ –∏ –±—É–¥–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –∑–∞ RSVP: —Ç–∞–∫ –Ω–∞–º –ø—Ä–æ—â–µ –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å.</p>
        <p class="note">–ü–∞–ª–∏—Ç—Ä–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ ‚Äî –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏: –Ω–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π –∏ sage-green.</p>
      </div>
      <div class="note">
        <p>–ï—Å–ª–∏ —É –≤–∞—Å –ø–æ—è–≤—è—Ç—Å—è –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –∑–∞—Ä–∞–Ω–µ–µ. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞ –¥–æ–±–∞–≤–∏–º –±–ª–∏–∂–µ –∫ –¥–∞—Ç–µ.</p>
      </div>
    </div>
  </div>

  <!-- NEW: –ö–æ–≥–¥–∞ –∏ –≥–¥–µ -->
  <div class="card" style="margin-top:12px">
    <h3>–ö–æ–≥–¥–∞ –∏ –≥–¥–µ</h3>
    <div class="kit">
      <div>
        <p><b>4‚Äì5 –∏—é–ª—è 2026</b> ‚Ä¢ –†–æ—Å—Å–∏—è, <b>–ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –í–æ–¥—ã</b><br><span class="note">–¢–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –ø–æ–∑–∂–µ, –≤–∞–º –ø—Ä–∏–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.</span></p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="kbtn" target="_blank" href="https://yandex.ru/maps/?text=%D0%9C%D0%B8%D0%BD%D0%B5%D1%80%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%92%D0%BE%D0%B4%D1%8B">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö</a>
        <a class="kbtn" target="_blank" href="https://www.google.com/maps/search/?api=1&query=%D0%9C%D0%B8%D0%BD%D0%B5%D1%80%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5+%D0%92%D0%BE%D0%B4%D1%8B">–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps</a>
      </div>
    </div>
  </div>

  <!-- RSVP -->
  <div class="card" style="margin-top:12px">
    <h3>RSVP</h3>
    <form onsubmit="return send(event)">
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label>–í–∞—à–µ –∏–º—è</label><input required id="n"></div>
        <div><label>Email</label><input type="email" id="e" placeholder="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="p" placeholder="+7... (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></div>
        <div><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label><input type="number" min="1" max="10" id="g" value="1"></div>
      </div>
      <div style="margin-top:12px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label><input id="t"></div>
      <br><button class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><div id="ok" class="ok"></div>
    </form>
  </div>

  <p class="note">–§–æ—Ç–æ –¥–ª—è —à–∞–ø–∫–∏ –º–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –∫–∞–∫ <code>/var/www/karmanovy/hero.jpg</code></p>
</div>
<script>
(function(){
  const qs=new URLSearchParams(location.search);
  if(qs.get('ok')==='1'){document.getElementById('hi').style.display='block';history.replaceState(null,'',location.pathname);}

  function tick(){
    const t=${WEDDING_TS}-Date.now(); const z=Math.max(0,t);
    const d=Math.floor(z/864e5), h=Math.floor(z%864e5/36e5), m=Math.floor(z%36e5/6e4), s=Math.floor(z%6e4/1e3);
    cd.textContent=d; ch.textContent=h; cm.textContent=m; cs.textContent=s;
  }
  tick(); setInterval(tick,1000);

  window.send=async function(e){
    e.preventDefault();
    const body={
      name: n.value.trim(),
      email: document.getElementById("e").value.trim(), // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
      phone: document.getElementById('p').value.trim(),
      guests: +g.value,
      notes: t.value.trim()
    };
    const r=await fetch('/api/rsvp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(r.ok){
      const j=await r.json(); if(j&&j.id){localStorage.setItem('rsvp_id',String(j.id));}
      localStorage.setItem('rsvp',JSON.stringify(body));
      location.href='/?ok=1';
    }else{
      ok.textContent='–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    }
    return false;
  };
})();
</script>`;

const lk = `<!doctype html><meta charset="utf-8"><title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî –°–≤–∞–¥—å–±–∞ –ö–∞—Ä–º–∞–Ω–æ–≤—ã—Ö</title>
<style>body{font-family:system-ui;background:#F6F4F2;color:#2B2B2B;margin:0}.w{max-width:960px;margin:0 auto;padding:24px}
.card{background:#fff;border:1px solid #0001;border-radius:16px;padding:16px}
.btn{background:#C9D7C2;border:0;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #0003}
.grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}@media(max-width:900px){.grid{grid-template-columns:1fr}}</style>
<div class="w">
  <div style="margin-bottom:8px"><a href="/" style="text-decoration:none;border:1px solid #0001;border-radius:999px;padding:6px 12px;display:inline-block">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></div>
  <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≥–æ—Å—Ç—è</h1>
  <div id="msg" style="margin:8px 0;opacity:.8"></div>

  <div class="card">
    <h3>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h3>
    <div class="grid">
      <div><label>–ò–º—è</label><input id="n"></div>
      <div><label>Email</label><input id="e"></div>
    </div>
    <div class="grid">
      <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="p"></div>
      <div><label>–ì–æ—Å—Ç–µ–π</label><input id="g" type="number" min="1" max="10"></div>
    </div>
    <div style="margin-top:12px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label><input id="t"></div>
    <div style="margin-top:12px"><button class="btn" onclick="saveLocal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É —Å–µ–±—è</button></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h3>
    <div class="grid">
      <div><label>–ï–¥–∞</label><input id="food"></div>
      <div><label>–ù–∞–ø–∏—Ç–∫–∏</label><input id="drink"></div>
    </div>
    <div style="margin-top:12px"><label>–ê–ª–ª–µ—Ä–≥–∏–∏ / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</label><textarea id="all" rows="3"></textarea></div>
    <div style="margin-top:12px"><button class="btn" onclick="savePrefs()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button></div>
    <div id="ok" style="margin-top:8px;color:#317031;font-weight:700"></div>
  </div>
</div>
<script>
async function load(){
  const id=localStorage.getItem('rsvp_id'); if(!id){document.getElementById('msg').textContent='–í—ã –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ RSVP.'; return;}
  const r=await fetch('/api/me?id='+encodeURIComponent(id)); if(!r.ok){document.getElementById('msg').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.'; return;}
  const j=await r.json(); if(j&&j.id){n.value=j.name||''; e.value=j.email||''; p.value=j.phone||''; g.value=j.guests||1; t.value=j.notes||''; food.value=j.food_prefs||''; drink.value=j.drink_prefs||''; all.value=j.allergies||''; document.getElementById('msg').textContent='–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã.';}
}
function saveLocal(){let b={name:n.value.trim(),email:e.value.trim(),phone:p.value.trim(),guests:+g.value,notes:t.value.trim()}; localStorage.setItem('rsvp',JSON.stringify(b)); document.getElementById('msg').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.'; setTimeout(()=>document.getElementById('msg').textContent='',2000)}
async function savePrefs(){
  const id=localStorage.getItem('rsvp_id'); if(!id){ok.textContent='–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ RSVP –Ω–∞ –≥–ª–∞–≤–Ω–æ–π.'; return;}
  const body={id:+id,food:food.value.trim(),drink:drink.value.trim(),allergies:all.value.trim()};
  const r=await fetch('/api/prefs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  ok.textContent=r.ok?'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É.':'–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.'; if(r.ok) setTimeout(()=>ok.textContent='',2000);
}
load();
</script>`;

function csvEscape(s){return '"'+String(s??'').replace(/"/g,'""')+'"'}

async function tg(text){
  if(!process.env.TELEGRAM_BOT_TOKEN||!process.env.TELEGRAM_CHAT_ID) return;
  try{await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:process.env.TELEGRAM_CHAT_ID,text,disable_web_page_preview:true})});}catch{}
}
function sendRSVPTg(b){
  const text=['üì® –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ RSVP',`üë§ –ò–º—è: ${b.name}`,b.email?`‚úâÔ∏è ${b.email}`:'',b.phone?`üì± ${b.phone}`:'',`üë• –ì–æ—Å—Ç–µ–π: ${b.guests}`,b.notes?`üìù ${b.notes}`:'',`‚è±Ô∏è ${new Date().toLocaleString('ru-RU',{timeZone:'Europe/Moscow'})}`].filter(Boolean).join('\\n');
  return tg(text);
}
function sendPrefsTg(id,b){
  const text=['üßæ –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è',`#ID: ${id}`,b.food?`üçΩ –ï–¥–∞: ${b.food}`:'',b.drink?`ü•Ç –ù–∞–ø–∏—Ç–∫–∏: ${b.drink}`:'',b.allergies?`‚ö†Ô∏è –ê–ª–ª–µ—Ä–≥–∏–∏: ${b.allergies}`:''].filter(Boolean).join('\\n'); return tg(text);
}

const server=http.createServer((req,res)=>{
  const {pathname,searchParams} = new URL(req.url,'http://x');

  if(req.method==='GET' && pathname==='/hero.jpg'){
    const f=path.join('/var/www/karmanovy','hero.jpg');
    return fs.stat(f,(e,s)=>{ if(e) {res.writeHead(404);return res.end('');}
      res.writeHead(200,{'content-type':'image/jpeg','content-length':s.size}); fs.createReadStream(f).pipe(res);
    });
  }

  if((req.method==='GET'||req.method==='HEAD') && pathname==='/'){res.writeHead(200,{'content-type':'text/html; charset=utf-8'});return res.end(page);}
  if((req.method==='GET'||req.method==='HEAD') && pathname.startsWith('/lk')){res.writeHead(200,{'content-type':'text/html; charset=utf-8'});return res.end(lk);}

  if(req.method==='POST' && pathname==='/api/rsvp'){
    let d=''; req.on('data',c=>d+=c); req.on('end',async()=>{
      try{
        const b=JSON.parse(d||'{}');
        const name=String(b.name||'').trim();
        const email=String(b.email||'').trim();
        const phone=String(b.phone||'').trim();
        const guests=Number(b.guests||1);
        const notes=String(b.notes||'').trim();
        if(!name || !Number.isFinite(guests) || guests<1 || guests>20){res.writeHead(400);return res.end('{"ok":false}');}
        const ip=(req.headers['x-real-ip']||req.socket.remoteAddress||'').toString();
        if(!okRate(ip)){res.writeHead(429);return res.end('{"ok":false,"reason":"rate"}');}
        const ua=req.headers['user-agent']||'';
        const r=await pool.query('INSERT INTO rsvp(name,email,phone,guests,notes,ip,user_agent) VALUES ($1,$2,$3,$4,$5,$6,$7) RETURNING id,created_at',[name,email,phone,guests,notes,ip,ua]);
        sendRSVPTg({name,email,phone,guests,notes}).catch(()=>{});
        res.writeHead(200,{'content-type':'application/json'}); return res.end(JSON.stringify({ok:true,id:r.rows[0].id,ts:r.rows[0].created_at}));
      }catch(e){console.error(e);res.writeHead(500);res.end('{"ok":false}');}
    }); return;
  }

  if(req.method==='GET' && pathname==='/api/me'){
    const id=Number(searchParams.get('id')); if(!Number.isInteger(id)){res.writeHead(400);return res.end('{"ok":false}');}
    return pool.query('SELECT id,name,email,phone,guests,notes,food_prefs,drink_prefs,allergies FROM rsvp WHERE id=$1',[id])
      .then(r=>{ if(!r.rows[0]){res.writeHead(404);return res.end('{"ok":false}');}
        res.writeHead(200,{'content-type':'application/json'}); res.end(JSON.stringify(r.rows[0])); })
      .catch(e=>{console.error(e);res.writeHead(500);res.end('{"ok":false}');});
  }

  if(req.method==='POST' && pathname==='/api/prefs'){
    let d=''; req.on('data',c=>d+=c); req.on('end',async()=>{
      try{
        const b=JSON.parse(d||'{}'); const id=Number(b.id);
        if(!Number.isInteger(id)){res.writeHead(400);return res.end('{"ok":false}');}
        await pool.query('UPDATE rsvp SET food_prefs=$2, drink_prefs=$3, allergies=$4 WHERE id=$1',[id,b.food||null,b.drink||null,b.allergies||null]);
        sendPrefsTg(id,b).catch(()=>{});
        res.writeHead(200,{'content-type':'application/json'}); return res.end('{"ok":true}');
      }catch(e){console.error(e);res.writeHead(500);res.end('{"ok":false}');}
    }); return;
  }

  // CSV –∏ HTML-–∞–¥–º–∏–Ω–∫–∞ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

  res.writeHead(404); res.end('not found');
});
server.listen(process.env.PORT||3000,()=>console.log('OK 3000'));
